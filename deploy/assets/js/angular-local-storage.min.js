var isDefined=angular.isDefined,isUndefined=angular.isUndefined,isNumber=angular.isNumber,isObject=angular.isObject,isArray=angular.isArray,isString=angular.isString,extend=angular.extend,toJson=angular.toJson;angular.module("LocalStorageModule",[]).provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/",secure:!1},this.defaultToCookie=!0,this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(e){return this.prefix=e,this},this.setStorageType=function(e){return this.storageType=e,this},this.setDefaultToCookie=function(e){return this.defaultToCookie=!!e,this},this.setStorageCookie=function(e,t,o){return this.cookie.expiry=e,this.cookie.path=t,this.cookie.secure=o,this},this.setStorageCookieDomain=function(e){return this.cookie.domain=e,this},this.setNotify=function(e,t){return this.notify={setItem:e,removeItem:t},this},this.$get=["$rootScope","$window","$document","$parse","$timeout",function(e,t,o,r,n){function i(o){if(o||(o=t.event),l.setItem&&isString(o.key)&&h(o.key)){var r=d(o.key);n(function(){e.$broadcast("LocalStorageModule.notification.changed",{key:r,newvalue:o.newValue,storageType:s.storageType})})}}var a,s=this,c=s.prefix,u=s.cookie,l=s.notify,g=s.storageType;o?o[0]&&(o=o[0]):o=document,"."!==c.substr(-1)&&(c=c?c+".":"");var f=function(e){return c+e},d=function(e){return e.replace(new RegExp("^"+c,"g"),"")},h=function(e){return 0===e.indexOf(c)},m=function(){try{var o=g in t&&null!==t[g],r=f("__"+Math.round(1e7*Math.random()));return o&&(a=t[g],a.setItem(r,""),a.removeItem(r)),o}catch(n){return s.defaultToCookie&&(g="cookie"),e.$broadcast("LocalStorageModule.notification.error",n.message),!1}},y=m(),T=function(t,o,r){var n=M();try{if(x(r),o=isUndefined(o)?null:toJson(o),!y&&s.defaultToCookie||"cookie"===s.storageType)return y||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),l.setItem&&e.$broadcast("LocalStorageModule.notification.setitem",{key:t,newvalue:o,storageType:"cookie"}),O(t,o);try{a&&a.setItem(f(t),o),l.setItem&&e.$broadcast("LocalStorageModule.notification.setitem",{key:t,newvalue:o,storageType:s.storageType})}catch(i){return e.$broadcast("LocalStorageModule.notification.error",i.message),O(t,o)}return!0}finally{x(n)}},v=function(t,o){var r=M();try{if(x(o),!y&&s.defaultToCookie||"cookie"===s.storageType)return y||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),L(t);var n=a?a.getItem(f(t)):null;if(!n||"null"===n)return null;try{return JSON.parse(n)}catch(i){return n}}finally{x(r)}},p=function(){var t=M();try{var o=0;arguments.length>=1&&("localStorage"===arguments[arguments.length-1]||"sessionStorage"===arguments[arguments.length-1])&&(o=1,x(arguments[arguments.length-1]));var r,n;for(r=0;r<arguments.length-o;r++)if(n=arguments[r],!y&&s.defaultToCookie||"cookie"===s.storageType)y||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),l.removeItem&&e.$broadcast("LocalStorageModule.notification.removeitem",{key:n,storageType:"cookie"}),$(n);else try{a.removeItem(f(n)),l.removeItem&&e.$broadcast("LocalStorageModule.notification.removeitem",{key:n,storageType:s.storageType})}catch(i){e.$broadcast("LocalStorageModule.notification.error",i.message),$(n)}}finally{x(t)}},S=function(t){var o=M();try{if(x(t),!y)return e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),[];var r=c.length,n=[];for(var i in a)if(i.substr(0,r)===c)try{n.push(i.substr(r))}catch(s){return e.$broadcast("LocalStorageModule.notification.error",s.Description),[]}return n}finally{x(o)}},k=function(t,o){var r=M();try{x(o);var n=c?new RegExp("^"+c):new RegExp,i=t?new RegExp(t):new RegExp;if(!y&&s.defaultToCookie||"cookie"===s.storageType)return y||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),E();if(!y&&!s.defaultToCookie)return!1;var u=c.length;for(var l in a)if(n.test(l)&&i.test(l.substr(u)))try{p(l.substr(u))}catch(g){return e.$broadcast("LocalStorageModule.notification.error",g.message),E()}return!0}finally{x(r)}},b=function(){try{return t.navigator.cookieEnabled||"cookie"in o&&(o.cookie.length>0||(o.cookie="test").indexOf.call(o.cookie,"test")>-1)}catch(r){return e.$broadcast("LocalStorageModule.notification.error",r.message),!1}}(),O=function(t,r,n,i){if(isUndefined(r))return!1;if((isArray(r)||isObject(r))&&(r=toJson(r)),!b)return e.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var a="",s=new Date,c="";if(null===r?(s.setTime(s.getTime()+-864e5),a="; expires="+s.toGMTString(),r=""):isNumber(n)&&0!==n?(s.setTime(s.getTime()+24*n*60*60*1e3),a="; expires="+s.toGMTString()):0!==u.expiry&&(s.setTime(s.getTime()+24*u.expiry*60*60*1e3),a="; expires="+s.toGMTString()),t){var l="; path="+u.path;u.domain&&(c="; domain="+u.domain),"boolean"==typeof i?i===!0&&(c+="; secure"):u.secure===!0&&(c+="; secure"),o.cookie=f(t)+"="+encodeURIComponent(r)+a+l+c}}catch(g){return e.$broadcast("LocalStorageModule.notification.error",g.message),!1}return!0},L=function(t){if(!b)return e.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var r=o.cookie&&o.cookie.split(";")||[],n=0;n<r.length;n++){for(var i=r[n];" "===i.charAt(0);)i=i.substring(1,i.length);if(0===i.indexOf(f(t)+"=")){var a=decodeURIComponent(i.substring(c.length+t.length+1,i.length));try{var s=JSON.parse(a);return"number"==typeof s?a:s}catch(u){return a}}}return null},$=function(e){O(e,null)},E=function(){for(var e=null,t=c.length,r=o.cookie.split(";"),n=0;n<r.length;n++){for(e=r[n];" "===e.charAt(0);)e=e.substring(1,e.length);var i=e.substring(t,e.indexOf("="));$(i)}},M=function(){return g},x=function(e){return e&&g!==e&&(g=e,y=m()),y},C=function(e,t,o,n,i){n=n||t;var a=v(n,i);return null===a&&isDefined(o)?a=o:isObject(a)&&isObject(o)&&(a=extend(a,o)),r(t).assign(e,a),e.$watch(t,function(e){T(n,e,i)},isObject(e[t]))};y&&(t.addEventListener?(t.addEventListener("storage",i,!1),e.$on("$destroy",function(){t.removeEventListener("storage",i)})):t.attachEvent&&(t.attachEvent("onstorage",i),e.$on("$destroy",function(){t.detachEvent("onstorage",i)})));var _=function(e){var o=M();try{x(e);for(var r=0,n=t[g],i=0;i<n.length;i++)0===n.key(i).indexOf(c)&&r++;return r}finally{x(o)}};return{isSupported:y,getStorageType:M,setStorageType:x,set:T,add:T,get:v,keys:S,remove:p,clearAll:k,bind:C,deriveKey:f,underiveKey:d,length:_,defaultToCookie:this.defaultToCookie,cookie:{isSupported:b,set:O,add:O,get:L,remove:$,clearAll:E}}}]});
